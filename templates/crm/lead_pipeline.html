{% extends 'base.html' %}
{% load crm_filters %}

{% block title %}Pipeline CRM - Fuet Mágico{% endblock %}

{% block extra_head %}
<style>
    [x-cloak] { display: none !important; }
    
    /* Página do pipeline - ocupa toda a altura restante do viewport */
    .pipeline-page {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    /* Custom scrollbar - horizontal */
    .pipeline-wrapper::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }
    
    .pipeline-wrapper::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .pipeline-wrapper::-webkit-scrollbar-thumb {
        background-color: #dbc693;
        border-radius: 4px;
    }
    
    .pipeline-wrapper {
        scrollbar-width: thin;
        scrollbar-color: #dbc693 transparent;
    }
    
    /* Colunas esticam para a altura total do wrapper */
    .kanban-column {
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease, min-width 0.3s ease;
        flex-shrink: 0;
    }
    
    .kanban-column-body {
        flex: 1;
    }
    
    /* Lead card hover effect */
    .lead-card {
        transition: all 0.2s ease;
    }
    
    .lead-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Sortable.js drag styles */
    .sortable-drag {
        transform: rotate(2deg);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
    }
</style>
{% endblock %}

{% block sub_navbar %}
{% include 'components/crm_navbar.html' %}
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="pipeline-page bg-gray-50 dark:bg-gray-900" x-data="{
    init() {
        // Calcular a altura restante do viewport
        this.$nextTick(() => {
            const rect = this.$el.getBoundingClientRect();
            this.$el.style.height = (window.innerHeight - rect.top) + 'px';
        });
        window.addEventListener('resize', () => {
            const rect = this.$el.getBoundingClientRect();
            this.$el.style.height = (window.innerHeight - rect.top) + 'px';
        });
    },
    
    toggleColumn(columnId) {
        const column = document.getElementById('column-' + columnId);
        if (column) {
            column.classList.toggle('collapsed');
        }
    }
}">
    <!-- Search & Actions Bar - Desktop -->
    <div class="hidden md:block bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 py-3">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between gap-4">
                <!-- Left: New Button -->
                <div class="flex items-center space-x-3">
                    <a href="{% url 'crm:lead_create' %}" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Novo</span>
                    </a>
                </div>
                
                <!-- Center: Search Bar -->
                <div class="flex-1 max-w-2xl relative" x-data="{ filtersOpen: false, searchQuery: '{{ search_query|default:'' }}' }">
                    <form method="GET" action="{% url 'crm:crm_home' %}" id="searchForm">
                        <div class="relative">
                            <input 
                                type="text" 
                                name="search"
                                x-model="searchQuery"
                                @focus="filtersOpen = true"
                                @input="filtersOpen = searchQuery.length > 0"
                                placeholder="Pesquisar oportunidades..."
                                class="w-full px-4 py-2 pl-10 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="hidden" name="field" id="searchField" value="{{ search_field|default:'title' }}">
                            
                            <!-- Search Icon -->
                            <svg class="absolute left-3 top-2.5 h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            
                            <!-- Filter Dropdown Button (Chevron) -->
                            <button 
                                type="button"
                                @click="filtersOpen = !filtersOpen"
                                class="absolute right-2 top-2 p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    
                        <!-- Combined Filters Dropdown -->
                        <div x-show="filtersOpen" 
                             @click.away="filtersOpen = false"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 max-h-96 overflow-y-auto"
                             style="display: none;">
                            <div class="p-3">
                                <!-- Search Fields Section -->
                                <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">PESQUISAR POR CAMPO:</p>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='title'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Title</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='contact'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Contact</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='source'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Source</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='assigned_to'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Assigned To</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='priority'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Priority</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                                <a href="#" @click.prevent="document.getElementById('searchField').value='description'; document.getElementById('searchForm').submit();" class="block px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    Search <strong>Description</strong> for: <span class="text-primary" x-text="searchQuery || '...'"></span>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Right: View Toggle -->
                <div class="flex items-center space-x-4">
                    <!-- View Toggle -->
                    <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                        <!-- Kanban View (active) -->
                        <a href="{% url 'crm:crm_home' %}" class="px-3 py-1.5 bg-primary text-white transition-colors">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                            </svg>
                        </a>
                        <!-- List View -->
                        <a href="#" class="px-3 py-1.5 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Actions Bar - Mobile -->
    <div class="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 py-3">
        <div class="px-4">
            <div class="flex items-center gap-2 mb-3">
                <!-- New Button -->
                <a href="{% url 'crm:lead_create' %}" class="p-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </a>
                
                <!-- Search -->
                <form method="GET" action="{% url 'crm:crm_home' %}" class="flex-1">
                    <div class="relative">
                        <input type="text" name="search" value="{{ search_query|default:'' }}" placeholder="Pesquisar oportunidades..." 
                               class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        <svg class="absolute left-3 top-2.5 h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </form>
                
                <!-- View Toggle -->
                <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                    <a href="{% url 'crm:crm_home' %}" class="px-2 py-1.5 bg-primary text-white">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                        </svg>
                    </a>
                    <a href="#" class="px-2 py-1.5 text-gray-600 dark:text-gray-400">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Kanban Pipeline Wrapper -->
    <div class="pipeline-wrapper" style="width: 95%; margin: 0 auto; padding-top: 0.5rem; padding-bottom: 2rem; overflow: auto;">
        <div class="pipeline-container" style="display: flex; flex-direction: row; gap: 1rem;">
        {% for stage_data in pipeline_data %}
            <div id="column-{{ stage_data.stage.id }}" 
                 class="kanban-column" 
                 x-data="{ collapsed: {{ stage_data.is_folded|yesno:'true,false' }} }"
                 :style="collapsed ? 'width: 150px; min-width: 150px; flex-shrink: 0;' : 'width: 300px; min-width: 300px; flex-shrink: 0;'">
            
            <!-- Collapsed Header (when folded) -->
            <div x-show="collapsed" class="px-2 pb-3">
                <!-- Color Bar -->
                <div class="w-full h-1 rounded mb-2" style="background-color: {{ stage_data.stage.color }};"></div>
                
                <!-- Name + Count + Arrow in one horizontal line -->
                <div class="flex items-center justify-between gap-1">
                    <h3 class="font-bold text-xs text-gray-200 truncate">{{ stage_data.stage.name }}</h3>
                    <div class="flex items-center gap-0.5 flex-shrink-0">
                        <span class="text-xs text-gray-400" data-stage-count="{{ stage_data.stage.id }}">({{ stage_data.count }})</span>
                        <button @click="collapsed = false" 
                                class="p-0.5 text-gray-400 hover:text-white transition-colors"
                                title="Expandir">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Normal Header (when expanded) -->
            <div x-show="!collapsed" class="px-2 pb-3">
                <!-- Stage Name & Add Button -->
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-sm text-gray-200 dark:text-gray-200">{{ stage_data.stage.name }}</h3>
                    
                    <div class="flex items-center gap-1">
                        <!-- Collapse Button (if fold_by_default) -->
                        {% if stage_data.is_folded %}
                        <button @click="collapsed = true" 
                                class="p-0.5 text-gray-400 hover:text-white transition-colors" 
                                title="Colapsar">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        {% endif %}
                        
                        <!-- Add Button -->
                        <button class="p-0.5 text-gray-400 hover:text-white transition-colors" title="Nova oportunidade">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Progress Bar + Value -->
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden" style="max-width: 75%;">
                        <div class="h-full rounded-full" style="background-color: {{ stage_data.stage.color }}; width: 100%;"></div>
                    </div>
                    <span class="text-xs text-gray-400 font-medium whitespace-nowrap" data-stage-total="{{ stage_data.stage.id }}">
                        {{ stage_data.total_value|short_value }}
                    </span>
                </div>
            </div>
            
            <!-- Column Body (Cards) - always in DOM for Sortable.js, but visually hidden when collapsed -->
            <div class="kanban-column-body space-y-2 px-1"
                 :style="collapsed ? 'height: 0; min-height: 0; overflow: hidden; padding: 0;' : 'min-height: 200px;'"
                 data-stage-id="{{ stage_data.stage.id }}">
                {% for lead in stage_data.leads %}
                <div class="lead-card rounded-lg p-3 shadow-sm cursor-move border hover:border-gray-600
                    {% if lead.is_overdue %}bg-red-900/30 border-red-700/50{% elif lead.is_warning %}bg-yellow-900/30 border-yellow-700/50{% else %}bg-gray-800 dark:bg-gray-800 border-gray-700{% endif %}"
                    data-lead-id="{{ lead.id }}"
                    onclick="navigateToLead('{{ lead.id }}')"
                    style="cursor: pointer;">
                    
                    <!-- Lead Title -->
                    <h4 class="font-medium text-white text-sm mb-1">
                        {{ lead.title }}
                    </h4>
                    
                    <!-- Value -->
                    <div class="text-sm text-gray-300 mb-1">
                        $ {{ lead.estimated_value|floatformat:2 }}
                    </div>
                    
                    <!-- Contact -->
                    {% if lead.contact %}
                    <div class="text-xs text-gray-400 mb-2">
                        {{ lead.contact.name }}
                    </div>
                    {% endif %}
                    
                    <!-- Source Tag -->
                    {% if lead.source %}
                    <div class="mb-2">
                        <span class="inline-block px-2 py-0.5 text-xs rounded-full font-medium
                            {% if lead.source == 'WEBSITE' %}bg-blue-900/50 text-blue-300
                            {% elif lead.source == 'REFERRAL' %}bg-green-900/50 text-green-300
                            {% elif lead.source == 'SOCIAL' %}bg-purple-900/50 text-purple-300
                            {% elif lead.source == 'PHONE' %}bg-yellow-900/50 text-yellow-300
                            {% elif lead.source == 'EMAIL' %}bg-red-900/50 text-red-300
                            {% elif lead.source == 'EVENT' %}bg-pink-900/50 text-pink-300
                            {% elif lead.source == 'ADVERTISING' %}bg-orange-900/50 text-orange-300
                            {% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ lead.get_source_display }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Footer: Stars + Activity Icons + Avatar -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-1">
                            <!-- Priority Stars -->
                            <div class="flex items-center text-sm">
                                {% if lead.priority == 'HIGH' %}<span class="text-yellow-400">★★</span><span class="text-gray-600">★</span>
                                {% elif lead.priority == 'MEDIUM' %}<span class="text-yellow-400">★</span><span class="text-gray-600">★★</span>
                                {% else %}<span class="text-gray-600">★★★</span>{% endif %}
                            </div>
                            
                            <!-- Activity Icons -->
                            <button class="p-0.5 text-green-400 hover:text-green-300 transition-colors" title="Ligar">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Assigned User Avatar -->
                        {% if lead.assigned_to %}
                        <div class="flex items-center" title="{{ lead.assigned_to.username }}">
                            <div class="w-6 h-6 bg-primary rounded-full flex items-center justify-center text-white text-xs font-medium">
                                {{ lead.assigned_to.username|slice:":1"|upper }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        </div><!-- /pipeline-container -->
    </div><!-- /pipeline-wrapper -->
</div><!-- /pipeline-page -->

<!-- SortableJS for Drag & Drop (loaded from CDN) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get CSRF token for AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Function to format values with K/M/B suffixes (matching Python filter)
        function formatValue(value) {
            if (value >= 1000000000) {
                const formatted = value / 1000000000;
                return formatted === Math.floor(formatted) ? Math.floor(formatted) + 'B' : formatted.toFixed(1) + 'B';
            } else if (value >= 1000000) {
                const formatted = value / 1000000;
                return formatted === Math.floor(formatted) ? Math.floor(formatted) + 'M' : formatted.toFixed(1) + 'M';
            } else if (value >= 1000) {
                const formatted = value / 1000;
                return formatted === Math.floor(formatted) ? Math.floor(formatted) + 'K' : formatted.toFixed(1) + 'K';
            }
            return Math.floor(value).toString();
        }

        // Function to update column totals and counts in the UI
        function updateColumnUI(stageId, total, count) {
            // Update total value (expanded view)
            const totalElement = document.querySelector(`[data-stage-total="${stageId}"]`);
            if (totalElement) {
                totalElement.textContent = formatValue(total);
            }
            
            // Update count (both collapsed and expanded views)
            const countElement = document.querySelector(`[data-stage-count="${stageId}"]`);
            if (countElement) {
                countElement.textContent = `(${count})`;
            }
        }

        // Function to move lead to new stage via AJAX
        function moveLeadToStage(leadId, newStageId, cardElement) {
            fetch(`/crm/leads/${leadId}/change-stage/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ new_stage_id: newStageId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI with new totals and counts
                    updateColumnUI(data.old_stage_id, data.old_column_total, data.old_column_count);
                    updateColumnUI(data.new_stage_id, data.new_column_total, data.new_column_count);
                } else {
                    alert('Erro ao mover oportunidade: ' + (data.error || 'Erro desconhecido'));
                    location.reload();
                }
            })
            .catch(error => {
                alert('Erro na comunicação com o servidor');
                location.reload();
            });
        }

        // Track drag state to prevent click navigation during drag
        let isDragging = false;
        
        // Navigate to lead detail page
        function navigateToLead(leadId) {
            if (!isDragging) {
                window.location.href = `/crm/leads/${leadId}/`;
            }
        }

        // Initialize Sortable on each column
        const columns = document.querySelectorAll('.kanban-column-body');
        columns.forEach(column => {
            Sortable.create(column, {
                group: 'leads',  // Allow drag between ALL columns
                animation: 150,
                ghostClass: 'opacity-50',
                dragClass: 'sortable-drag',
                fallbackOnBody: true,
                swapThreshold: 0.65,
                handle: '.lead-card',  // Only cards are draggable
                draggable: '.lead-card',
                onStart: function(evt) {
                    isDragging = true;
                },
                onEnd: function(evt) {
                    const leadId = evt.item.dataset.leadId;
                    const oldStageId = evt.from.dataset.stageId;
                    const newStageId = evt.to.dataset.stageId;
                    
                    if (oldStageId !== newStageId) {
                        moveLeadToStage(leadId, newStageId, evt.item);
                    }
                    
                    // Reset drag state after a short delay to prevent click
                    setTimeout(() => {
                        isDragging = false;
                    }, 100);
                }
            });
        });
    });
</script>
{% endblock %}
